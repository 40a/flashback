package flashback

import (
	"time"

	"gopkg.in/mgo.v2/bson"
)

// OpType is the name of mongo op type
type OpType string

// Document represents the json-like infromation of an op
type Document map[string]interface{}

// Contains a list of mongo op types
const (
	Insert        OpType = "insert"
	Update        OpType = "update"
	Remove        OpType = "remove"
	Query         OpType = "query"
	Command       OpType = "command"
	Count         OpType = "command.count"
	FindAndModify OpType = "command.findandmodify"
)

// AllOpTypes specifies all supported op types
var AllOpTypes = []OpType{
	Insert,
	Update,
	Remove,
	Query,
	Count,
	FindAndModify,
}

// RawOp represents an op generated by the record utility
// It must (currently) be normalized into an Op before it can be replayed
type RawOp struct {
	Ns         string    `bson:"ns"`
	Timestamp  time.Time `bson:"ts"`
	Type       OpType    `bson:"op"`
	NToSkip    int64     `bson:"ntoskip"`
	NToReturn  int64     `bson:"ntoreturn"`
	QueryDoc   bson.D    `bson:"query"`
	CommandDoc bson.D    `bson:"command"`
	InsertDoc  bson.D    `bson:"o"`
	UpdateDoc  bson.D    `bson:"updateobj"`
}

// Op represents a MongoDB operation that contains enough details to be
// replayed.
type Op struct {
	Database   string
	Collection string
	Type       OpType

	// indicates when this op was performed
	Timestamp time.Time
	// The details of this op, which may vary from different op types.
	Content Document
}

// GetElem is a helper to fetch a specific key from bson.D
// The second return value indicates whether or not the key exists
func GetElem(doc bson.D, key string) (interface{}, bool) {
	for _, elem := range doc {
		if elem.Name == key {
			return elem.Value, true
		}
	}

	return nil, false
}
